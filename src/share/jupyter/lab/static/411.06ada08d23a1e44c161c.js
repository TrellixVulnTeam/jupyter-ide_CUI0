(self["webpackChunk_jupyterlab_application_top"]=self["webpackChunk_jupyterlab_application_top"]||[]).push([[411],{31955:(e,t,s)=>{"use strict";s.d(t,{M:()=>n});const n=()=>{let e=true;return(t,s)=>{if(e){e=false;try{t()}finally{e=true}}else if(s!==undefined){s()}}}},411:(e,t,s)=>{"use strict";s.r(t);s.d(t,{IDocumentProviderFactory:()=>l,ProviderMock:()=>a,WebSocketProviderWithLocks:()=>ie,getAnonymousUserName:()=>o,getRandomColor:()=>c,moonsOfJupyter:()=>n,userColors:()=>i});const n=["Metis","Adrastea","Amalthea","Thebe","Io","Europa","Ganymede","Callisto","Themisto","Leda","Ersa","Pandia","Himalia","Lysithea","Elara","Dia","Carpo","Valetudo","Euporie","Eupheme","Helike","Euanthe","Hermippe","Praxidike","Thyone","Thelxinoe","Ananke","Mneme","Orthosie","Harpalyke","Iocaste","Erinome","Aitne","Herse","Taygete","Eukelade","Carme","Isonoe","Autonoe","Philophrosyne","Cyllene","Pasithee","Pasiphae","Sponde","Eurydome","Kalyke","Hegemone","Kale","Kallichore","Chaldene","Arche","Eirene","Kore","Megaclite","Aoede","Callirrhoe","Sinope"];const o=()=>"Anonymous "+n[Math.floor(Math.random()*n.length)];const i=["#12A0D3","#17AB30","#CC8500","#A79011","#ee6352","#609DA9","#4BA749","#00A1B3"];const c=()=>i[Math.floor(Math.random()*i.length)];class a{requestInitialContent(){return Promise.resolve(false)}putInitializedState(){}acquireLock(){return Promise.resolve(0)}releaseLock(e){}destroy(){}setPath(e){}}var r=s(9727);const l=new r.Token("@jupyterlab/docprovider:IDocumentProviderFactory");var h=s(94072);var d=s(84795);var u=s(11038);var f=s(23205);var w=s(24803);var p=s(55852);const _=new Map;class m{constructor(e){this.room=e;this.onmessage=null;p.z((t=>t.key===e&&this.onmessage!==null&&this.onmessage({data:w.Gh(t.newValue||"")})))}postMessage(e){p.X.setItem(this.room,w.s3(w.eh(e)))}}const y=typeof BroadcastChannel==="undefined"?m:BroadcastChannel;const v=e=>f.Yu(_,e,(()=>{const t=new Set;const s=new y(e);s.onmessage=e=>t.forEach((t=>t(e.data)));return{bc:s,subs:t}}));const g=(e,t)=>v(e).subs.add(t);const b=(e,t)=>v(e).subs.delete(t);const C=(e,t)=>{const s=v(e);s.bc.postMessage(t);s.subs.forEach((e=>e(t)))};var I=s(40870);const k=0;const M=1;const E=2;const U=(e,t)=>{d.uE(e,k);const s=u.encodeStateVector(t);d.mP(e,s)};const L=(e,t,s)=>{d.uE(e,M);d.mP(e,u.encodeStateAsUpdate(t,s))};const q=(e,t,s)=>L(t,s,h.HN(e));const R=(e,t,s)=>{try{u.applyUpdate(t,h.HN(e),s)}catch(n){console.error("Caught error while handling a Yjs update",n)}};const S=(e,t)=>{d.uE(e,E);d.mP(e,t)};const A=R;const P=(e,t,s,n)=>{const o=h.yg(e);switch(o){case k:q(e,t,s);break;case M:R(e,s,n);break;case E:A(e,s,n);break;default:throw new Error("Unknown message type")}return o};const H=0;const T=(e,t)=>{encoding.writeVarUint(e,H);encoding.writeVarString(e,t)};const x=(e,t,s)=>{switch(h.yg(e)){case H:s(t,h.kf(e))}};var B=s(6493);var D=s(31955);var j=s(75736);var W=s(21332);var z=s(69600);const V=e=>{const t={};const s=e.split("?");const n=s[s.length-1].split("&");for(var o=0;o<n.length;o++){const e=n[o];if(e.length>0){const s=e.split("=");t[decodeURIComponent(s[0])]=decodeURIComponent(s[1]||"")}}return t};const G=e=>z.UI(e,((e,t)=>`${encodeURIComponent(t)}=${encodeURIComponent(e)}`)).join("&");var K=s(34406);const N=0;const $=3;const F=1;const Z=2;const J=[];J[N]=(e,t,s,n,o)=>{d.uE(e,N);const i=P(t,e,s.doc,s);if(n&&i===M&&!s.synced){s.synced=true}};J[$]=(e,t,s,n,o)=>{d.uE(e,F);d.mP(e,B.xq(s.awareness,Array.from(s.awareness.getStates().keys())))};J[F]=(e,t,s,n,o)=>{B.oy(s.awareness,h.HN(t),s)};J[Z]=(e,t,s,n,o)=>{x(t,s.doc,Q)};const O=1200;const Y=2500;const X=3e4;const Q=(e,t)=>console.warn(`Permission denied to access ${e.url}.\n${t}`);const ee=(e,t,s)=>{const n=h.l1(t);const o=d.Mf();const i=h.yg(n);const c=e.messageHandlers[i];if(c){c(o,n,e,s,i)}else{console.error("Unable to compute message")}return o};const te=e=>{if(e.shouldConnect&&e.ws===null){const t=new e._WS(e.url);t.binaryType="arraybuffer";e.ws=t;e.wsconnecting=true;e.wsconnected=false;e.synced=false;t.onmessage=s=>{e.wsLastMessageReceived=I.ZG();const n=ee(e,new Uint8Array(s.data),true);if(d.kE(n)>1){t.send(d._f(n))}};t.onclose=()=>{e.ws=null;e.wsconnecting=false;if(e.wsconnected){e.wsconnected=false;e.synced=false;B.Ag(e.awareness,Array.from(e.awareness.getStates().keys()).filter((t=>t!==e.doc.clientID)),e);e.emit("status",[{status:"disconnected"}])}else{e.wsUnsuccessfulReconnects++}setTimeout(te,W.VV(W.mv(e.wsUnsuccessfulReconnects+1)*O,Y),e)};t.onopen=()=>{e.wsLastMessageReceived=I.ZG();e.wsconnecting=false;e.wsconnected=true;e.wsUnsuccessfulReconnects=0;e.emit("status",[{status:"connected"}]);const s=d.Mf();d.uE(s,N);U(s,e.doc);t.send(d._f(s));if(e.awareness.getLocalState()!==null){const s=d.Mf();d.uE(s,F);d.mP(s,B.xq(e.awareness,[e.doc.clientID]));t.send(d._f(s))}};e.emit("status",[{status:"connecting"}])}};const se=(e,t)=>{if(e.wsconnected){e.ws.send(t)}if(e.bcconnected){e.mux((()=>{C(e.bcChannel,t)}))}};class ne extends j.y{constructor(e,t,s,{connect:n=true,awareness:o=new B.GL(s),params:i={},WebSocketPolyfill:c=WebSocket,resyncInterval:a=-1}={}){super();while(e[e.length-1]==="/"){e=e.slice(0,e.length-1)}const r=G(i);this.bcChannel=e+"/"+t;this.url=e+"/"+t+(r.length===0?"":"?"+r);this.roomname=t;this.doc=s;this._WS=c;this.awareness=o;this.wsconnected=false;this.wsconnecting=false;this.bcconnected=false;this.wsUnsuccessfulReconnects=0;this.messageHandlers=J.slice();this.mux=D.M();this._synced=false;this.ws=null;this.wsLastMessageReceived=0;this.shouldConnect=n;this._resyncInterval=0;if(a>0){this._resyncInterval=setInterval((()=>{if(this.ws){const e=d.Mf();d.uE(e,N);U(e,s);this.ws.send(d._f(e))}}),a)}this._bcSubscriber=e=>{this.mux((()=>{const t=ee(this,new Uint8Array(e),false);if(d.kE(t)>1){C(this.bcChannel,d._f(t))}}))};this._updateHandler=(e,t)=>{if(t!==this){const t=d.Mf();d.uE(t,N);S(t,e);se(this,d._f(t))}};this.doc.on("update",this._updateHandler);this._awarenessUpdateHandler=({added:e,updated:t,removed:s},n)=>{const i=e.concat(t).concat(s);const c=d.Mf();d.uE(c,F);d.mP(c,B.xq(o,i));se(this,d._f(c))};this._beforeUnloadHandler=()=>{B.Ag(this.awareness,[s.clientID],"window unload")};if(typeof window!=="undefined"){window.addEventListener("beforeunload",this._beforeUnloadHandler)}else if(typeof K!=="undefined"){K.on("exit",(()=>this._beforeUnloadHandler))}o.on("update",this._awarenessUpdateHandler);this._checkInterval=setInterval((()=>{if(this.wsconnected&&X<I.ZG()-this.wsLastMessageReceived){this.ws.close()}}),X/10);if(n){this.connect()}}get synced(){return this._synced}set synced(e){if(this._synced!==e){this._synced=e;this.emit("synced",[e]);this.emit("sync",[e])}}destroy(){if(this._resyncInterval!==0){clearInterval(this._resyncInterval)}clearInterval(this._checkInterval);this.disconnect();if(typeof window!=="undefined"){window.removeEventListener("beforeunload",this._beforeUnloadHandler)}else if(typeof K!=="undefined"){K.off("exit",(()=>this._beforeUnloadHandler))}this.awareness.off("update",this._awarenessUpdateHandler);this.doc.off("update",this._updateHandler);super.destroy()}connectBc(){if(!this.bcconnected){g(this.bcChannel,this._bcSubscriber);this.bcconnected=true}this.mux((()=>{const e=d.Mf();d.uE(e,N);U(e,this.doc);C(this.bcChannel,d._f(e));const t=d.Mf();d.uE(t,N);L(t,this.doc);C(this.bcChannel,d._f(t));const s=d.Mf();d.uE(s,$);C(this.bcChannel,d._f(s));const n=d.Mf();d.uE(n,F);d.mP(n,B.xq(this.awareness,[this.doc.clientID]));C(this.bcChannel,d._f(n))}))}disconnectBc(){const e=d.Mf();d.uE(e,F);d.mP(e,B.xq(this.awareness,[this.doc.clientID],new Map));se(this,d._f(e));if(this.bcconnected){b(this.bcChannel,this._bcSubscriber);this.bcconnected=false}}disconnect(){this.shouldConnect=false;this.disconnectBc();if(this.ws!==null){this.ws.close()}}connect(){this.shouldConnect=true;if(!this.wsconnected&&this.ws===null){te(this);this.connectBc()}}}var oe=s(40999);class ie extends ne{constructor(e){var t;super(e.url,e.contentType+":"+e.path,e.ymodel.ydoc,{awareness:e.ymodel.awareness});this._currentLockRequest=null;this._initialContentRequest=null;this._path=e.path;this._contentType=e.contentType;this._serverUrl=e.url;const s="#"+oe.jS("--usercolor",c().slice(1));const n=decodeURIComponent(oe.jS("--username",o()));const i=e.ymodel.awareness;const a=i.getLocalState();if(a&&((t=a.user)===null||t===void 0?void 0:t.name)==null){e.ymodel.awareness.setLocalStateField("user",{name:n,color:s})}this.messageHandlers[127]=(e,t,s,n,o)=>{const i=h.Jl(t);const c=this._currentLockRequest;this._currentLockRequest=null;if(c){c.resolve(i)}};this.messageHandlers[125]=(e,t,s,n,o)=>{const i=h.iU(t);if(i.byteLength>0){setTimeout((()=>{u.applyUpdate(this.doc,i)}),0)}const c=this._initialContentRequest;this._initialContentRequest=null;if(c){c.resolve(i.byteLength>0)}};this._isInitialized=false;this._onConnectionStatus=this._onConnectionStatus.bind(this);this.on("status",this._onConnectionStatus)}setPath(e){if(e!==this._path){this._path=e;const t=d.Mf();d.cW(t,123);const s=unescape(encodeURIComponent(this._contentType+":"+e));for(let e=0;e<s.length;e++){d.cW(t,s.codePointAt(e))}this._sendMessage(d._f(t));this.disconnectBc();this.bcChannel=this._serverUrl+"/"+this._contentType+":"+this._path;this.url=this.bcChannel;this.connectBc()}}requestInitialContent(){if(this._initialContentRequest){return this._initialContentRequest.promise}this._initialContentRequest=new r.PromiseDelegate;this._sendMessage(new Uint8Array([125]));setTimeout((()=>{var e;return(e=this._initialContentRequest)===null||e===void 0?void 0:e.resolve(false)}),1e3);return this._initialContentRequest.promise}putInitializedState(){const e=d.Mf();d.uE(e,124);d.HK(e,u.encodeStateAsUpdate(this.doc));this._sendMessage(d._f(e));this._isInitialized=true}acquireLock(){if(this._currentLockRequest){return this._currentLockRequest.promise}this._sendMessage(new Uint8Array([127]));if(this._requestLockInterval){clearInterval(this._requestLockInterval)}this._requestLockInterval=setInterval((()=>{if(this.wsconnected){this._sendMessage(new Uint8Array([127]))}}),500);let e,t;const s=new Promise(((s,n)=>{e=s;t=n}));this._currentLockRequest={promise:s,resolve:e,reject:t};return s}releaseLock(e){const t=d.Mf();d.uE(t,126);d.Ep(t,e);this._sendMessage(d._f(t));if(this._requestLockInterval){clearInterval(this._requestLockInterval)}}_sendMessage(e){const t=()=>{setTimeout((()=>{if(this.wsconnected){this.ws.send(e)}else{this.once("status",t)}}),0)};t()}async _onConnectionStatus(e){if(this._isInitialized&&e.status==="connected"){const e=await this.acquireLock();const t=await this.requestInitialContent();if(!t){this.putInitializedState()}this.releaseLock(e)}}}}}]);